<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T…ôl…ôb…ôl…ôrin Q…ôl…ômi - AI & Multimedia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        @keyframes rainbowBG {
            0% { background-color: #3b82f6; } 14% { background-color: #ef4444; }
            28% { background-color: #10b981; } 42% { background-color: #ffffff; }
            56% { background-color: #111827; } 70% { background-color: #f59e0b; }
            84% { background-color: #f97316; } 100% { background-color: #3b82f6; }
        }
        body { animation: rainbowBG 20s infinite alternate; transition: 3s; min-height: 100vh; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.4); }
        #app-screen, #loader-screen, #register-form, #shop-modal, #download-area { display: none; }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div id="auth-screen" class="glass p-8 w-full max-sm mt-12 shadow-2xl">
        <h1 class="text-3xl font-black text-center mb-8 italic tracking-tighter">T…ôl…ôb…ôl…ôrin Q…ôl…ômi</h1>
        
        <div id="login-form">
            <input type="text" id="l-name" placeholder="Ad Soyad" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="text" id="l-group" placeholder="Qrup (m…ôs: 511.24)" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="password" id="l-pass" placeholder="≈ûifr…ô" class="w-full p-4 mb-6 border rounded-2xl outline-none text-sm">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition">Daxil Ol</button>
            <p class="text-center mt-6 text-xs italic">Hesabƒ±n yoxdur? <span onclick="showReg()" class="font-bold underline cursor-pointer">Qeydiyyat</span></p>
        </div>

        <div id="register-form">
            <input type="text" id="r-name" placeholder="Ad Soyad" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="text" id="r-group" placeholder="Qrup (m…ôs: 511.24)" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="password" id="r-pass" placeholder="≈ûifr…ô" class="w-full p-4 mb-6 border rounded-2xl outline-none text-sm">
            <button onclick="handleRegister()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition">Qeydiyyatƒ± Tamamla</button>
            <p class="text-center mt-6 text-xs italic">Hesabƒ±n var? <span onclick="showLogin()" class="font-bold underline cursor-pointer">Giri≈ü</span></p>
        </div>
    </div>

    <div id="app-screen" class="w-full max-w-4xl">
        <header class="glass p-6 flex justify-between items-center mb-8 shadow-xl">
            <div>
                <h2 class="font-black text-xl italic" id="u-name">...</h2>
                <p class="text-[10px] font-bold text-gray-400">ID: <span id="u-id" class="text-red-500"></span></p>
            </div>
            <button onclick="openShop()" class="bg-black text-white px-5 py-3 rounded-2xl font-black flex items-center gap-2">
                <span id="coin-icon">ü™ô</span> <span id="u-coins">0</span>
            </button>
        </header>

        <div class="glass p-8">
            <h3 class="text-xl font-black mb-6 uppercase text-gray-600 text-center tracking-widest">AI & Multimedia T…ôqdimat</h3>
            
            <textarea id="topic" rows="3" placeholder="T…ôqdimat m√∂vzusunu yazƒ±n (m…ôs: S√ºni ƒ∞ntellektin G…ôl…ôc…ôyi)..." class="w-full p-4 border rounded-2xl mb-4 italic outline-none"></textarea>
            
            <div class="flex justify-between items-center mb-8 bg-gray-50 p-4 rounded-2xl font-bold">
                <span>Slayd Sayƒ± (1-30):</span>
                <input type="number" id="scount" value="10" min="1" max="30" class="w-16 p-2 border rounded-xl text-center">
            </div>

            <button onclick="createSlides()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition">T∆èQDƒ∞MATI HAZIRLA</button>

            <div id="download-area" class="mt-8 p-6 border-4 border-dashed border-green-400 rounded-3xl text-center bg-green-50 animate-bounce">
                <button id="final-download-btn" class="bg-green-600 text-white px-10 py-4 rounded-2xl font-black shadow-xl">FAYLI Y√úKL∆è (.PPTX)</button>
            </div>
        </div>
    </div>

    <div id="loader-screen" class="fixed inset-0 z-[200] bg-black/90 flex flex-col items-center justify-center text-white p-6">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 mb-4"></div>
        <h2 id="loader-text" class="text-xl font-bold italic text-center">AI Slaydlarƒ± hazƒ±rlayƒ±r...</h2>
        <p class="text-xs mt-2 text-gray-400">Z…ôhm…ôt olmasa 15-20 saniy…ô g√∂zl…ôyin.</p>
    </div>

    <script>
        // --- FIREBASE KONFƒ∞QURASƒ∞YASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfmsZqzt96I-GIjBx106Yo7uz4LVLnj2A", 
            authDomain: "telebelerinqelemi.firebaseapp.com",
            projectId: "telebelerinqelemi",
            storageBucket: "telebelerinqelemi.appspot.com",
            messagingSenderId: "1096176011716",
            appId: "1:1096176011716:web:6e1875e52c719702672338"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- API KEY-L∆èR ---
        const GEMINI_API_KEY = "AIzaSyAfmsZqzt96I-GIjBx106Yo7uz4LVLnj2A";
        const PEXELS_API_KEY = "y7oGfTzlDj4q3avc92F4ALLnjFDqMLwwgp5Za8Mov9six2cl4yyB7tPC";

        let activeUser = null;

        function showReg() { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; }
        function showLogin() { document.getElementById('login-form').style.display='block'; document.getElementById('register-form').style.display='none'; }
        function openShop() { alert("Tezlikl…ô!"); }

        async function handleRegister() {
            const name = document.getElementById('r-name').value;
            const group = document.getElementById('r-group').value;
            const pass = document.getElementById('r-pass').value;
            if(!name.includes(" ") || !/^\d{1,3}\.(22|23|24|25)$/.test(group)) return alert('Ad Soyad (bo≈üluqla) v…ô Qrup (m…ôs: 511.24) d√ºzg√ºn yazƒ±n!');
            
            const id = 'ID' + Math.floor(Math.random()*8999+1000);
            try {
                await db.collection("users").doc(id).set({ id, name, group, pass, coins: 5, isVip: false });
                alert("Uƒüurlu! ID-niz: " + id);
                login(id);
            } catch (e) { alert("Bazaya qo≈üulma x…ôtasƒ±! Firestore Rules-u yoxlayƒ±n."); }
        }

        async function handleLogin() {
            const name = document.getElementById('l-name').value;
            const group = document.getElementById('l-group').value;
            const pass = document.getElementById('l-pass').value;
            const snap = await db.collection("users").where("name","==",name).where("group","==",group).where("pass","==",pass).get();
            if(!snap.empty) login(snap.docs[0].id); else alert("Giri≈ü m…ôlumatlarƒ± tapƒ±lmadƒ±!");
        }

        async function login(id) {
            const doc = await db.collection("users").doc(id).get();
            activeUser = doc.data();
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            updateUI();
        }

        function updateUI() {
            document.getElementById('u-name').innerText = activeUser.name;
            document.getElementById('u-id').innerText = activeUser.id;
            document.getElementById('u-coins').innerText = activeUser.isVip ? "Lƒ∞Mƒ∞TSƒ∞Z" : activeUser.coins + " i-Coin";
        }

        async function fetchPexels(kw) {
            try {
                const res = await fetch(`https://api.pexels.com/v1/search?query=${kw}&per_page=1`, { headers: { Authorization: PEXELS_API_KEY }});
                const data = await res.json();
                return data.photos[0]?.src.large || "";
            } catch { return ""; }
        }

        async function createSlides() {
            const topic = document.getElementById('topic').value;
            const count = parseInt(document.getElementById('scount').value);
            if(!topic) return alert("M√∂vzunu daxil edin!");

            document.getElementById('loader-screen').style.display = 'flex';
            document.getElementById('download-area').style.display = 'none';
            
            try {
                // MODEL: gemini-1.5-flash (√ñd…ôni≈üsiz v…ô daha stabil)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const prompt = `M√∂vzu: "${topic}". C…ômi ${count} slayd √º√ß√ºn Az…ôrbaycan dilind…ô m…ôlumat hazƒ±rla. 
                Cavabƒ± YALNIZ JSON formatƒ±nda ver, ba≈üqa s√∂z yazma. 
                Format: [{"title": "Ba≈ülƒ±q", "content": "M…ôtn...", "kw": "A√ßar s√∂z (ƒ∞ngilisc…ô ≈ü…ôkil √º√ß√ºn)"}]`;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await res.json();
                
                if (data.error) throw new Error(data.error.message);

                let rawText = data.candidates[0].content.parts[0].text;
                // JSON-u t…ômizl…ôm…ôk √º√ß√ºn regex
                rawText = rawText.replace(/```json|```/gi, "").trim();
                
                const slides = JSON.parse(rawText);

                for(let s of slides) { s.img = await fetchPexels(s.kw); }

                let pptx = new PptxGenJS();
                slides.forEach(s => {
                    let slide = pptx.addSlide();
                    if(s.img) slide.addImage({ path: s.img, x: 0, y: 0, w: '100%', h: '100%', opacity: 35 });
                    slide.addText(s.title, { x: 0.5, y: 0.5, w: '90%', fontSize: 24, bold: true, color: '1E3A8A' });
                    slide.addText(s.content, { x: 0.5, y: 1.5, w: '90%', fontSize: 14, color: '333333' });
                });

                document.getElementById('download-area').style.display = 'block';
                document.getElementById('final-download-btn').onclick = () => pptx.writeFile({ fileName: topic.replace(/\s/g, '_') });

            } catch (e) { 
                console.error(e);
                alert("AI x…ôtasƒ±! Ehtimal: API Key limiti v…ô ya internet baƒülantƒ±sƒ±. Bir az sonra yenid…ôn yoxlayƒ±n."); 
            } finally { 
                document.getElementById('loader-screen').style.display = 'none'; 
            }
        }
    </script>
</body>
</html>
