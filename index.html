<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T…ôl…ôb…ôl…ôrin Q…ôl…ômi - AI & Multimedia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        @keyframes rainbowBG {
            0% { background-color: #3b82f6; } 14% { background-color: #ef4444; }
            28% { background-color: #10b981; } 42% { background-color: #ffffff; }
            56% { background-color: #111827; } 70% { background-color: #f59e0b; }
            84% { background-color: #f97316; } 100% { background-color: #3b82f6; }
        }
        body { animation: rainbowBG 20s infinite alternate; transition: 3s; min-height: 100vh; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.4); }
        #app-screen, #loader-screen, #register-form, #shop-modal, #download-area, #admin-panel { display: none; }
        
        /* ƒ∞mza stili */
        .admin-trigger {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 10px;
            font-weight: bold;
            color: rgba(0,0,0,0.3);
            cursor: pointer;
            user-select: none;
            z-index: 1000;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div class="admin-trigger" onclick="adminClick()">ismayilismayilov</div>

    <div id="auth-screen" class="glass p-8 w-full max-sm mt-12 shadow-2xl">
        <h1 class="text-3xl font-black text-center mb-8 italic tracking-tighter">T…ôl…ôb…ôl…ôrin Q…ôl…ômi</h1>
        
        <div id="login-form">
            <input type="text" id="l-name" placeholder="Ad Soyad" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="text" id="l-group" placeholder="Qrup (m…ôs: 511.24)" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="password" id="l-pass" placeholder="≈ûifr…ô" class="w-full p-4 mb-6 border rounded-2xl outline-none text-sm">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition">Daxil Ol</button>
            <p class="text-center mt-6 text-xs italic">Hesabƒ±n yoxdur? <span onclick="showReg()" class="font-bold underline cursor-pointer">Qeydiyyat</span></p>
        </div>

        <div id="register-form">
            <input type="text" id="r-name" placeholder="Ad Soyad" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="text" id="r-group" placeholder="Qrup (m…ôs: 511.24)" class="w-full p-4 mb-3 border rounded-2xl outline-none text-sm">
            <input type="password" id="r-pass" placeholder="≈ûifr…ô" class="w-full p-4 mb-6 border rounded-2xl outline-none text-sm">
            <button onclick="handleRegister()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition">Qeydiyyatƒ± Tamamla</button>
            <p class="text-center mt-6 text-xs italic">Hesabƒ±n var? <span onclick="showLogin()" class="font-bold underline cursor-pointer">Giri≈ü</span></p>
        </div>
    </div>

    <div id="app-screen" class="w-full max-w-4xl">
        <header class="glass p-6 flex justify-between items-center mb-8 shadow-xl">
            <div>
                <h2 class="font-black text-xl italic" id="u-name">...</h2>
                <p class="text-[10px] font-bold text-gray-400">ID: <span id="u-id" class="text-red-500"></span></p>
            </div>
            <button onclick="openShop()" class="bg-black text-white px-5 py-3 rounded-2xl font-black flex items-center gap-2">
                <span id="coin-icon">ü™ô</span> <span id="u-coins">0</span>
            </button>
        </header>

        <div class="glass p-8">
            <h3 class="text-xl font-black mb-6 uppercase text-gray-600 text-center tracking-widest">AI & Multimedia T…ôqdimat</h3>
            <textarea id="topic" rows="3" placeholder="T…ôqdimat m√∂vzusunu yazƒ±n..." class="w-full p-4 border rounded-2xl mb-4 italic outline-none"></textarea>
            <div class="flex justify-between items-center mb-8 bg-gray-50 p-4 rounded-2xl font-bold">
                <span>Slayd Sayƒ± (1-30):</span>
                <input type="number" id="scount" value="10" min="1" max="30" class="w-16 p-2 border rounded-xl text-center">
            </div>
            <button onclick="createSlides()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition">T∆èQDƒ∞MATI HAZIRLA (-1 ü™ô)</button>
            <div id="download-area" class="mt-8 p-6 border-4 border-dashed border-green-400 rounded-3xl text-center bg-green-50 animate-bounce">
                <button id="final-download-btn" class="bg-green-600 text-white px-10 py-4 rounded-2xl font-black shadow-xl">FAYLI Y√úKL∆è (.PPTX)</button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="fixed inset-0 z-[300] bg-black/80 flex items-center justify-center p-4">
        <div class="glass p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-black mb-4">Coin Maƒüazasƒ± ü™ô</h2>
            <div class="grid grid-cols-1 gap-4">
                <button onclick="addCoins(1)" class="bg-yellow-500 text-white p-4 rounded-2xl font-bold">+1 i-Coin (Bonus)</button>
                <button onclick="makeVip()" class="bg-red-600 text-white p-4 rounded-2xl font-bold animate-pulse">Vƒ∞P OL (Limitsiz)</button>
            </div>
            <button onclick="closeShop()" class="mt-8 text-gray-500 underline font-bold">Baƒüla</button>
        </div>
    </div>

    <div id="admin-panel" class="fixed inset-0 z-[500] bg-white overflow-y-auto p-4 md:p-10 text-black">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black">Admin Panel ‚öôÔ∏è</h2>
                <button onclick="closeAdmin()" class="bg-red-600 text-white px-6 py-2 rounded-xl">√áƒ±xƒ±≈ü</button>
            </div>
            <div class="bg-gray-100 rounded-3xl p-4 overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b-2">
                            <th class="p-3">Ad Soyad</th>
                            <th class="p-3">Qrup</th>
                            <th class="p-3">Coin</th>
                            <th class="p-3">Vƒ∞P</th>
                            <th class="p-3">∆èm…ôliyyat</th>
                        </tr>
                    </thead>
                    <tbody id="admin-user-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loader-screen" class="fixed inset-0 z-[200] bg-black/90 flex flex-col items-center justify-center text-white p-6">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 mb-4"></div>
        <h2 class="text-xl font-bold italic">AI Hazƒ±rlayƒ±r...</h2>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAfmsZqzt96I-GIjBx106Yo7uz4LVLnj2A", 
            authDomain: "telebelerinqelemi.firebaseapp.com",
            projectId: "telebelerinqelemi",
            storageBucket: "telebelerinqelemi.appspot.com",
            messagingSenderId: "1096176011716",
            appId: "1:1096176011716:web:6e1875e52c719702672338"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const GEMINI_API_KEY = "AIzaSyAfmsZqzt96I-GIjBx106Yo7uz4LVLnj2A";
        const PEXELS_API_KEY = "y7oGfTzlDj4q3avc92F4ALLnjFDqMLwwgp5Za8Mov9six2cl4yyB7tPC";

        let activeUser = null;
        let adminClicks = 0;

        // ADMƒ∞N Gƒ∞Rƒ∞≈û M∆èNTƒ∞Qƒ∞
        function adminClick() {
            adminClicks++;
            if(adminClicks === 5) {
                adminClicks = 0;
                const p = prompt("Admin ≈ûifr…ôsi:");
                if(p === "qaqa0202") {
                    document.getElementById('admin-panel').style.display = 'block';
                    loadAdminUsers();
                } else {
                    alert("≈ûifr…ô yanlƒ±≈üdƒ±r!");
                }
            }
            // 3 saniy…ô …ôrzind…ô 5 d…ôf…ô basƒ±lmasa sƒ±fƒ±rlansƒ±n
            setTimeout(() => { adminClicks = 0; }, 3000);
        }

        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        async function loadAdminUsers() {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = "Y√ºkl…ônir...";
            const snap = await db.collection("users").get();
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                list.innerHTML += `
                <tr class="border-b">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3">${u.group}</td>
                    <td class="p-3">ü™ô ${u.coins}</td>
                    <td class="p-3">${u.isVip ? '‚úÖ' : '‚ùå'}</td>
                    <td class="p-3">
                        <button onclick="adminGift('${u.id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">+10</button>
                        <button onclick="adminVip('${u.id}', ${!u.isVip})" class="bg-purple-600 text-white px-2 py-1 rounded text-xs">Vƒ∞P</button>
                    </td>
                </tr>`;
            });
        }

        async function adminGift(id) {
            const ref = db.collection("users").doc(id);
            const u = (await ref.get()).data();
            await ref.update({ coins: (u.coins || 0) + 10 });
            loadAdminUsers();
        }

        async function adminVip(id, status) {
            await db.collection("users").doc(id).update({ isVip: status });
            loadAdminUsers();
        }

        // Dƒ∞G∆èR FUNKSƒ∞YALAR
        function showReg() { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; }
        function showLogin() { document.getElementById('login-form').style.display='block'; document.getElementById('register-form').style.display='none'; }
        function openShop() { document.getElementById('shop-modal').style.display = 'flex'; }
        function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }

        async function handleRegister() {
            const name = document.getElementById('r-name').value;
            const group = document.getElementById('r-group').value;
            const pass = document.getElementById('r-pass').value;
            if(!name.includes(" ")) return alert('Ad Soyad yazƒ±n!');
            const id = 'ID' + Math.floor(Math.random()*8999+1000);
            await db.collection("users").doc(id).set({ id, name, group, pass, coins: 5, isVip: false });
            login(id);
        }

        async function handleLogin() {
            const name = document.getElementById('l-name').value;
            const group = document.getElementById('l-group').value;
            const pass = document.getElementById('l-pass').value;
            const snap = await db.collection("users").where("name","==",name).where("group","==",group).where("pass","==",pass).get();
            if(!snap.empty) login(snap.docs[0].id); else alert("M…ôlumatlar yanlƒ±≈üdƒ±r!");
        }

        async function login(id) {
            const doc = await db.collection("users").doc(id).get();
            activeUser = doc.data();
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            updateUI();
        }

        function updateUI() {
            document.getElementById('u-name').innerText = activeUser.name;
            document.getElementById('u-id').innerText = activeUser.id;
            document.getElementById('u-coins').innerText = activeUser.isVip ? "Vƒ∞P" : activeUser.coins + " ü™ô";
        }

        async function addCoins(amount) {
            if (activeUser.isVip) return;
            activeUser.coins += amount;
            await db.collection("users").doc(activeUser.id).update({ coins: activeUser.coins });
            updateUI();
        }

        async function makeVip() {
            activeUser.isVip = true;
            await db.collection("users").doc(activeUser.id).update({ isVip: true });
            updateUI();
            closeShop();
        }

        async function fetchPexels(kw) {
            try {
                const res = await fetch(`https://api.pexels.com/v1/search?query=${kw}&per_page=1`, { headers: { Authorization: PEXELS_API_KEY }});
                const data = await res.json();
                return data.photos[0]?.src.large || "";
            } catch { return ""; }
        }

        async function createSlides() {
            if (!activeUser.isVip && activeUser.coins < 1) return alert("Coin bitib!");
            const topic = document.getElementById('topic').value;
            const count = document.getElementById('scount').value;
            if(!topic) return alert("M√∂vzu yazƒ±n!");

            document.getElementById('loader-screen').style.display = 'flex';
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const prompt = `Create ${count} slides about ${topic} in Azerbaijani. JSON: [{"title": "...", "content": "...", "kw": "..."}]`;
                const res = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                let slides = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/gi, ""));

                let pptx = new PptxGenJS();
                for(let s of slides) {
                    let img = await fetchPexels(s.kw);
                    let slide = pptx.addSlide();
                    if(img) slide.addImage({ path: img, x:0, y:0, w:'100%', h:'100%', opacity:30 });
                    slide.addText(s.title, { x:0.5, y:0.5, fontSize:24, bold:true, color:'1E3A8A' });
                    slide.addText(s.content, { x:0.5, y:1.5, fontSize:14 });
                }

                if (!activeUser.isVip) {
                    activeUser.coins--;
                    await db.collection("users").doc(activeUser.id).update({ coins: activeUser.coins });
                    updateUI();
                }
                document.getElementById('download-area').style.display = 'block';
                document.getElementById('final-download-btn').onclick = () => pptx.writeFile({ fileName: topic });
            } catch (e) { alert("X…ôta ba≈ü verdi!"); }
            finally { document.getElementById('loader-screen').style.display = 'none'; }
        }
    </script>
</body>
</html>
